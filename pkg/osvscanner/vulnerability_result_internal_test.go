package osvscanner

import (
	"testing"

	"github.com/google/osv-scanner/internal/testutility"
	"github.com/google/osv-scanner/pkg/config"
	"github.com/google/osv-scanner/pkg/lockfile"
	"github.com/google/osv-scanner/pkg/models"
	"github.com/google/osv-scanner/pkg/osv"
	"github.com/google/osv-scanner/pkg/reporter"
)

func Test_assembleResult(t *testing.T) {
	t.Parallel()
	type args struct {
		r            reporter.Reporter
		packages     []scannedPackage
		vulnsResp    *osv.HydratedBatchedResponse
		licensesResp [][]models.License
		actions      ScannerActions
		config       *config.ConfigManager
	}
	packages := []scannedPackage{
		{
			Name:      "pkg-1",
			Ecosystem: lockfile.Ecosystem("npm"),
			Version:   "1.0.0",
			BlockLocation: models.FilePosition{
				Line:     models.Position{Start: 1, End: 1},
				Column:   models.Position{Start: 1, End: 1},
				Filename: "dir/package-lock.json",
			},
			Source: models.SourceInfo{
				Path: "dir/package-lock.json",
				Type: "lockfile",
			},
		},
		{
			Name:      "pkg-2",
			Ecosystem: lockfile.Ecosystem("npm"),
			Version:   "1.0.0",
			BlockLocation: models.FilePosition{
				Line:     models.Position{Start: 1, End: 1},
				Column:   models.Position{Start: 1, End: 1},
				Filename: "dir/package-lock.json",
			},
			Source: models.SourceInfo{
				Path: "dir/package-lock.json",
				Type: "lockfile",
			},
		},
		{
			Name:      "pkg-3",
			Ecosystem: lockfile.Ecosystem("npm"),
			Version:   "1.0.0",
			BlockLocation: models.FilePosition{
				Line:     models.Position{Start: 1, End: 1},
				Column:   models.Position{Start: 1, End: 1},
				Filename: "other-dir/package-lock.json",
			},
			Source: models.SourceInfo{
				Path: "other-dir/package-lock.json",
				Type: "lockfile",
			},
		},
	}
	vulnsResp := &osv.HydratedBatchedResponse{
		Results: []osv.Response{
			{Vulns: models.Vulnerabilities([]models.Vulnerability{
				{
					ID:      "GHSA-123",
					Aliases: []string{"CVE-123"},
				}, {
					ID: "CVE-123",
				},
			})},
			{Vulns: models.Vulnerabilities{}},
			{Vulns: models.Vulnerabilities([]models.Vulnerability{
				{
					ID: "GHSA-456",
				},
			})},
		},
	}
	licensesResp := [][]models.License{
		{models.License("MIT"), models.License("0BSD")},
		{models.License("MIT")},
		{models.License("UNKNOWN")},
	}
	makeLicensesResp := func() [][]models.License {
		cpy := make([][]models.License, len(licensesResp))
		copy(cpy, licensesResp)

		return cpy
	}

	callAnalysisStates := make(map[string]bool)

	tests := []struct {
		name string
		args args
	}{{
		name: "group_vulnerabilities",
		args: args{
			r:            &reporter.VoidReporter{},
			packages:     packages,
			vulnsResp:    vulnsResp,
			licensesResp: makeLicensesResp(),
			actions: ScannerActions{
				ExperimentalScannerActions: ExperimentalScannerActions{
					ShowAllPackages:       false,
					ScanLicensesAllowlist: nil,
				},
				CallAnalysisStates: callAnalysisStates,
			},
			config: &config.ConfigManager{},
		},
		want: models.VulnerabilityResults{
			Results: []models.PackageSource{
				{
					Source: models.SourceInfo{
						Path: "dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-1",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{
									ID:      "GHSA-123",
									Aliases: []string{"CVE-123"},
								},
								{
									ID: "CVE-123",
								},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"CVE-123", "GHSA-123"},
									Aliases: []string{"CVE-123", "GHSA-123"},
								},
							},
						},
					},
				},
				{
					Source: models.SourceInfo{
						Path: "other-dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-3",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "other-dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{ID: "GHSA-456"},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"GHSA-456"},
									Aliases: []string{"GHSA-456"},
								},
							},
						},
					},
				},
			},
			ResultsByPURL: map[string]models.PackageDetails{
				"pkg:npm/pkg-1@1.0.0": {
					Name:      "pkg-1",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-3@1.0.0": {
					Name:      "pkg-3",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "other-dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
			},
		},
	}, {
		name: "group_vulnerabilities_with_all_packages_included",
		args: args{
			r:            &reporter.VoidReporter{},
			packages:     packages,
			vulnsResp:    vulnsResp,
			licensesResp: makeLicensesResp(),
			actions: ScannerActions{
				ExperimentalScannerActions: ExperimentalScannerActions{
					ShowAllPackages:       true,
					ScanLicensesAllowlist: nil,
				},
				CallAnalysisStates: callAnalysisStates,
			},
			config: &config.ConfigManager{},
		},
		want: models.VulnerabilityResults{
			Results: []models.PackageSource{
				{
					Source: models.SourceInfo{
						Path: "dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-1",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{
									ID:      "GHSA-123",
									Aliases: []string{"CVE-123"},
								},
								{
									ID: "CVE-123",
								},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"CVE-123", "GHSA-123"},
									Aliases: []string{"CVE-123", "GHSA-123"},
								},
							},
						}, {
							Package: models.PackageInfo{
								Name:      "pkg-2",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
						},
					},
				},
				{
					Source: models.SourceInfo{
						Path: "other-dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-3",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "other-dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{ID: "GHSA-456"},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"GHSA-456"},
									Aliases: []string{"GHSA-456"},
								},
							},
						},
					},
				},
			},
			ResultsByPURL: map[string]models.PackageDetails{
				"pkg:npm/pkg-1@1.0.0": {
					Name:      "pkg-1",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-2@1.0.0": {
					Name:      "pkg-2",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-3@1.0.0": {
					Name:      "pkg-3",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "other-dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
			},
		},
	}, {
		name: "group_vulnerabilities_with_licenses",
		args: args{
			r:            &reporter.VoidReporter{},
			packages:     packages,
			vulnsResp:    vulnsResp,
			licensesResp: makeLicensesResp(),
			actions: ScannerActions{
				ExperimentalScannerActions: ExperimentalScannerActions{
					ShowAllPackages:       true,
					ScanLicensesSummary:   true,
					ScanLicensesAllowlist: nil,
				},
				CallAnalysisStates: callAnalysisStates,
			},
			config: &config.ConfigManager{},
		},
		want: models.VulnerabilityResults{
			ExperimentalAnalysisConfig: models.ExperimentalAnalysisConfig{
				Licenses: models.ExperimentalLicenseConfig{
					Summary:   true,
					Allowlist: []models.License{},
				},
			},
			Results: []models.PackageSource{
				{
					Source: models.SourceInfo{
						Path: "dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-1",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{
									ID:      "GHSA-123",
									Aliases: []string{"CVE-123"},
								},
								{
									ID: "CVE-123",
								},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"CVE-123", "GHSA-123"},
									Aliases: []string{"CVE-123", "GHSA-123"},
								},
							},
							Licenses: makeLicenses([]string{"MIT", "0BSD"}),
						}, {
							Package: models.PackageInfo{
								Name:      "pkg-2",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Licenses: makeLicenses([]string{"MIT"}),
						},
					},
				},
				{
					Source: models.SourceInfo{
						Path: "other-dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-3",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "other-dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{ID: "GHSA-456"},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"GHSA-456"},
									Aliases: []string{"GHSA-456"},
								},
							},
							Licenses: makeLicenses([]string{"UNKNOWN"}),
						},
					},
				},
			},
			ResultsByPURL: map[string]models.PackageDetails{
				"pkg:npm/pkg-1@1.0.0": {
					Name:      "pkg-1",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-2@1.0.0": {
					Name:      "pkg-2",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-3@1.0.0": {
					Name:      "pkg-3",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "other-dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
			},
		},
	}, {
		name: "group_vulnerabilities_with_license_allowlist",
		args: args{
		r:            &reporter.VoidReporter{},
		packages:     packages,
		vulnsResp:    vulnsResp,
		licensesResp: makeLicensesResp(),
		actions: ScannerActions{
		ExperimentalScannerActions: ExperimentalScannerActions{
		ShowAllPackages:       false,
		ScanLicensesAllowlist: []string{"MIT", "0BSD"},
	},
		CallAnalysisStates: callAnalysisStates,
	},

		config: &config.ConfigManager{},
	},
	}, {
		name: "group_vulnerabilities_with_license_allowlist_and_license_override",
		args: args{
			r:            &reporter.VoidReporter{},
			packages:     packages,
			vulnsResp:    vulnsResp,
			licensesResp: makeLicensesResp(),
			actions: ScannerActions{
				ExperimentalScannerActions: ExperimentalScannerActions{
					ShowAllPackages:       false,
					ScanLicensesAllowlist: []string{"MIT", "0BSD"},
				},
				CallAnalysisStates: callAnalysisStates,
			},
			config: &config.ConfigManager{
				OverrideConfig: &config.Config{
					PackageOverrides: []config.PackageOverrideEntry{
						{
							Name:      "pkg-3",
							Ecosystem: "npm",
							License: config.License{
								Override: []string{"MIT"},
							},
						},
					},
				},
			},
		},
		want: models.VulnerabilityResults{
			ExperimentalAnalysisConfig: models.ExperimentalAnalysisConfig{
				Licenses: models.ExperimentalLicenseConfig{
					Allowlist: []models.License{models.License("MIT"), models.License("0BSD")},
				},
			},
			Results: []models.PackageSource{
				{
					Source: models.SourceInfo{
						Path: "dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-1",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{
									ID:      "GHSA-123",
									Aliases: []string{"CVE-123"},
								},
								{
									ID: "CVE-123",
								},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"CVE-123", "GHSA-123"},
									Aliases: []string{"CVE-123", "GHSA-123"},
								},
							},
							Licenses: makeLicenses([]string{"MIT", "0BSD"}),
						},
					},
				},
				{
					Source: models.SourceInfo{
						Path: "other-dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-3",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "other-dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{ID: "GHSA-456"},
							},
						},
					},
				},
			},
			ResultsByPURL: map[string]models.PackageDetails{
				"pkg:npm/pkg-1@1.0.0": {
					Name:      "pkg-1",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-3@1.0.0": {
					Name:      "pkg-3",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "other-dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
			},
		},
	}, {
		name: "group_vulnerabilities_with_license_allowlist_and_all_packages",
		args: args{
			r:            &reporter.VoidReporter{},
			packages:     packages,
			vulnsResp:    vulnsResp,
			licensesResp: makeLicensesResp(),
			actions: ScannerActions{
				ExperimentalScannerActions: ExperimentalScannerActions{
					ShowAllPackages:       true,
					ScanLicensesAllowlist: []string{"MIT", "0BSD"},
				},
				CallAnalysisStates: callAnalysisStates,
			},
			config: &config.ConfigManager{},
		},
		want: models.VulnerabilityResults{
			ExperimentalAnalysisConfig: models.ExperimentalAnalysisConfig{
				Licenses: models.ExperimentalLicenseConfig{
					Allowlist: []models.License{models.License("MIT"), models.License("0BSD")},
				},
			},
			Results: []models.PackageSource{
				{
					Source: models.SourceInfo{
						Path: "dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-1",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{
									ID:      "GHSA-123",
									Aliases: []string{"CVE-123"},
								},
								{
									ID: "CVE-123",
								},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"CVE-123", "GHSA-123"},
									Aliases: []string{"CVE-123", "GHSA-123"},
								},
							},
							Licenses: makeLicenses([]string{"MIT", "0BSD"}),
						}, {
							Package: models.PackageInfo{
								Name:      "pkg-2",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "dir/package-lock.json",
								},
							},
							Licenses: makeLicenses([]string{"MIT"}),
						},
					},
				},
				{
					Source: models.SourceInfo{
						Path: "other-dir/package-lock.json",
						Type: "lockfile",
					},
					Packages: []models.PackageVulns{
						{
							Package: models.PackageInfo{
								Name:      "pkg-3",
								Ecosystem: "npm",
								Version:   "1.0.0",
								BlockLocation: models.FilePosition{
									Line:     models.Position{Start: 1, End: 1},
									Column:   models.Position{Start: 1, End: 1},
									Filename: "other-dir/package-lock.json",
								},
							},
							Vulnerabilities: []models.Vulnerability{
								{ID: "GHSA-456"},
							},
							Groups: []models.GroupInfo{
								{
									IDs:     []string{"GHSA-456"},
									Aliases: []string{"GHSA-456"},
								},
							},
							Licenses:          makeLicenses([]string{"UNKNOWN"}),
							LicenseViolations: makeLicenses([]string{"UNKNOWN"}),
						},
					},
				},
			},
			ResultsByPURL: map[string]models.PackageDetails{
				"pkg:npm/pkg-1@1.0.0": {
					Name:      "pkg-1",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-2@1.0.0": {
					Name:      "pkg-2",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
				"pkg:npm/pkg-3@1.0.0": {
					Name:      "pkg-3",
					Version:   "1.0.0",
					Ecosystem: "npm",
					Locations: []models.PackageLocations{
						{
							Block: models.PackageLocation{
								Filename:    "other-dir/package-lock.json",
								LineStart:   1,
								LineEnd:     1,
								ColumnStart: 1,
								ColumnEnd:   1,
							},
						},
					},
				},
			},
		},
	}}
	for _, tt := range tests {
		tt := tt // Reinitialize for t.Parallel()
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()
			got := buildVulnerabilityResults(tt.args.r, tt.args.packages, tt.args.vulnsResp, tt.args.licensesResp, tt.args.actions, tt.args.config)
			testutility.NewSnapshot().MatchJSON(t, got)
		})
	}
}
